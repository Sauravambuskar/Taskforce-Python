{% extends "base.html" %}

{% block title %}Tasks - Task Manager{% endblock %}
{% block page_title %}Tasks{% endblock %}

{% block content %}
<div class="tasks-page">
    <!-- Page Header -->
    <div class="page-header">
        <div class="header-actions">
            <a href="{{ url_for('create_task') }}" class="btn btn-primary">
                <i class="fas fa-plus"></i> New Task
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-bar">
        <div class="filter-group">
            <input type="text" id="searchInput" placeholder="Search tasks..." class="search-input" 
                   value="{{ search_query }}" onkeyup="filterTasks()">
            <i class="fas fa-search search-icon"></i>
        </div>
        <div class="filter-group">
            <select id="statusFilter" class="filter-select" onchange="filterTasks()">
                <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Status</option>
                <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>In Progress</option>
                <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
            </select>
        </div>
        <div class="filter-group">
            <select id="priorityFilter" class="filter-select" onchange="filterTasks()">
                <option value="all" {% if priority_filter == 'all' %}selected{% endif %}>All Priorities</option>
                <option value="urgent" {% if priority_filter == 'urgent' %}selected{% endif %}>Urgent</option>
                <option value="high" {% if priority_filter == 'high' %}selected{% endif %}>High</option>
                <option value="medium" {% if priority_filter == 'medium' %}selected{% endif %}>Medium</option>
                <option value="low" {% if priority_filter == 'low' %}selected{% endif %}>Low</option>
            </select>
        </div>
        <div class="filter-group">
            <select id="categoryFilter" class="filter-select" onchange="filterTasks()">
                <option value="all" {% if category_filter == 'all' %}selected{% endif %}>All Categories</option>
                {% for category in categories %}
                <option value="{{ category.id }}" {% if category_filter|string == category.id|string %}selected{% endif %}>
                    {{ category.name }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Floating quick action for mobile -->
    <a href="{{ url_for('create_task') }}" class="fab">
        <i class="fas fa-plus"></i>
        <span>New Task</span>
    </a>

    <!-- Tasks List -->
    <div class="tasks-container">
        {% if tasks %}
            <div class="tasks-grid">
                {% for task in tasks %}
                <div class="task-card" data-status="{{ task.status }}" data-priority="{{ task.priority }}">
                    <div class="task-card-header">
                        <div class="task-checkbox">
                            <input type="checkbox" {% if task.status == 'completed' %}checked{% endif %} 
                                   onchange="toggleTask({{ task.id }})">
                        </div>
                        <div class="task-actions-menu">
                            <button class="menu-btn" onclick="toggleMenu(this)">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="dropdown-menu">
                                <a href="{{ url_for('edit_task', task_id=task.id) }}">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                                <form method="POST" action="{{ url_for('delete_task', task_id=task.id) }}" 
                                      onsubmit="return confirm('Are you sure you want to delete this task?')">
                                    <button type="submit" class="delete-btn">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="task-card-body">
                        <h3 class="task-title">{{ task.title }}</h3>
                        {% if task.description and task.description|length > 0 %}
                        <p class="task-description">
                            {% if task.description|length > 100 %}
                                {{ task.description[:100] }}...
                            {% else %}
                                {{ task.description }}
                            {% endif %}
                        </p>
                        {% endif %}
                        <div class="task-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ task.progress or 0 }}%"></div>
                            </div>
                            <span class="progress-text">{{ task.progress or 0 }}%</span>
                        </div>
                    </div>
                    <div class="task-card-footer">
                        <div class="task-tags">
                            <span class="priority-badge priority-{{ task.priority }}">{{ task.priority }}</span>
                            {% if task.category %}
                            <span class="category-badge" style="background-color: {{ task.category.color }}20; color: {{ task.category.color }}">
                                <i class="fas fa-tag"></i> {{ task.category.name }}
                            </span>
                            {% endif %}
                        </div>
                        {% if task.due_date %}
                        {% set task_date = task.due_date.date() if task.due_date else None %}
                        {% set current_date = now.date() if now else None %}
                        {% set is_overdue = (task_date and current_date and task_date < current_date) %}
                        <div class="task-due-date {% if is_overdue and task.status != 'completed' %}overdue{% endif %}">
                            <i class="fas fa-calendar"></i>
                            {{ task.due_date.strftime('%b %d, %Y') }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-clipboard-list"></i>
                <h3>No tasks found</h3>
                <p>Create your first task to get started!</p>
                <a href="{{ url_for('create_task') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Create Task
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function filterTasks() {
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const priorityFilter = document.getElementById('priorityFilter');
    const categoryFilter = document.getElementById('categoryFilter');
    
    if (!searchInput || !statusFilter || !priorityFilter || !categoryFilter) {
        console.error('Filter elements not found');
        return;
    }
    
    const search = searchInput.value.trim();
    const status = statusFilter.value;
    const priority = priorityFilter.value;
    const category = categoryFilter.value;
    
    const params = new URLSearchParams();
    if (search) params.append('search', search);
    if (status !== 'all') params.append('status', status);
    if (priority !== 'all') params.append('priority', priority);
    if (category !== 'all') params.append('category', category);
    
    window.location.href = '/tasks?' + params.toString();
}

function toggleTask(taskId) {
    if (!taskId) {
        console.error('Task ID is required');
        return;
    }
    
    fetch(`/tasks/${taskId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.status) {
            location.reload();
        } else {
            console.error('Failed to toggle task:', data);
        }
    })
    .catch(error => {
        console.error('Error toggling task:', error);
        alert('Failed to update task. Please try again.');
    });
}

function toggleMenu(btn) {
    if (!btn) {
        console.error('Button element is required');
        return;
    }
    const menu = btn.nextElementSibling;
    if (!menu || !menu.classList.contains('dropdown-menu')) {
        console.error('Dropdown menu not found');
        return;
    }
    document.querySelectorAll('.dropdown-menu').forEach(m => {
        if (m !== menu) m.classList.remove('show');
    });
    menu.classList.toggle('show');
}

document.addEventListener('click', function(e) {
    if (!e.target.closest('.task-actions-menu')) {
        document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
    }
});
</script>
{% endblock %}

